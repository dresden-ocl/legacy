<?xml version="1.0" encoding="UTF-8" ?>
<project default="run" name="Build Dresden OCL.">

	<import file="./ant_common.xml" />

	<property environment="env" />
	<property file="buckminster.properties" />

	<property name="targetPlatformPath" location="${buildRoot}/tp" />
	<property name="workspacePath" location="${buildRoot}/workspace" />

	<property name="buckminster.output.root" location="${buildRoot}/output" />
	<property name="buckminster.temp.root" location="${buildRoot}/temp" />

	<!-- ================================= 
          target: init              
         ================================= -->
	<target name="init">

		<echo message="Removing old build" />
		<!-- only remove old workspace, so that Eclipse is not materialised every time... -->
		<delete dir="${workspacePath}" quiet="true" />

		<mkdir dir="${targetPlatformPath}" />
		<mkdir dir="${workspacePath}" />
	</target>

	<!-- ================================= 
          target: run              
         ================================= -->
	<target name="run" depends="init,init.build.properties" description="Builds Dresden OCL plug-ins.">
		<echo message="Using workspace ${workspacePath}" />

		<echo message="Setting jre to ${env.JAVA_HOME}" />
		<buckminster command="installJRE" workspace="${workspacePath}">
			<cmdargs>
				<arg value="--location" />
				<arg value="${env.JAVA_HOME}" />
			</cmdargs>
		</buckminster>

		<echo message="Setting targetPlatformPath to ${targetPlatformPath}" />
		<buckminster command="setpref" workspace="${workspacePath}">
			<cmdargs>
				<arg value="targetPlatformPath=${targetPlatformPath}" />
			</cmdargs>
		</buckminster>

		<echo message="Importing projects into workspace ${workspacePath}" />
		<echo message="Importing binaries into target platform ${targetPlatformPath}" />
		<buckminster command="import" workspace="${workspacePath}">
			<cmdargs>
				<arg value="${basedir}/dresdenocl.mspec" />
			</cmdargs>
		</buckminster>

		<echo message="Setting Preferences" />
		<buckminster command="setpreference" workspace="${workspacePath}">
			<cmdargs>
				<arg value="org.eclipse.buckminster.pde.targetOS=${target.os}" />
			</cmdargs>
		</buckminster>

		<buckminster command="setpreference" workspace="${workspacePath}">
			<cmdargs>
				<arg value="org.eclipse.buckminster.pde.targetWS=${target.ws}" />
			</cmdargs>
		</buckminster>

		<buckminster command="setpreference" workspace="${workspacePath}">
			<cmdargs>
				<arg value="org.eclipse.buckminster.pde.targetArch=${target.arch}" />
			</cmdargs>
		</buckminster>

		<!-- This is kind of hacky: first, build Java Sources, then build Scala sources and then Java again. Maybe, 
		the dependencies between the Scala and Java projects can be stated explicitly so that not everything has to 
		be compiled again.-->
		<echo message="Building" />
		<buckminster command="build" workspace="${workspacePath}">
			<cmdargs>
				<arg value="--thorough" />
			</cmdargs>
		</buckminster>

		<ant dir="./../tudresden.ocl20.pivot.language.ocl.staticsemantics" antfile="build.xml" target="Clean tudresden.ocl20.pivot.language.ocl.staticsemantics" inheritall="true">
			<property name="headless" value="true" />
		</ant>

		<buckminster command="build" workspace="${workspacePath}">
			<cmdargs>
				<arg value="--thorough" />
			</cmdargs>
		</buckminster>

		<echo message="Creating p2 site" />
		<buckminster command="perform" workspace="${workspacePath}">
			<cmdargs>
				<arg value="tudresden.ocl20.updatesite:eclipse.feature#site.p2" />
			</cmdargs>
		</buckminster>

		<echo message="Copying update site to ST server" />
		<scp todir="${usr}:${pwd}@lars.inf.tu-dresden.de:/srv/www/dresdenocl_updatesite/latestbuild" port="22" sftp="true" trust="true">
			<fileset dir="${buckminster.output.root}">
				<include name="**/*" />
				<include name="**" />
			</fileset>
		</scp>

	</target>

</project>